const CACHE_NAME="Keee-sw";let cachelist=[];self.cons={s:e=>{console.log(`%c[SUCCESS]%c ${e}`,"color:white;background:green;","")},w:e=>{console.log(`%c[WARNING]%c ${e}`,"color:brown;background:yellow;","")},i:e=>{console.log(`%c[INFO]%c ${e}`,"color:white;background:blue;","")},e:e=>{console.log(`%c[ERROR]%c ${e}`,"color:white;background:red;","")},d:e=>{console.log(`%c[DEBUG]%c ${e}`,"color:white;background:black;","")}};const generate_uuid=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}));self.db={read:(e,t)=>(t||(t={type:"text"}),new Promise(((t,n)=>{caches.open("Keee-sw").then((n=>{n.match(new Request(`https://LOCALCACHE/${encodeURIComponent(e)}`)).then((function(e){e||t(null),e.text().then((e=>t(e)))})).catch((()=>{t(null)}))}))}))),write:(e,t)=>new Promise(((n,s)=>{caches.open("Keee-sw").then((function(s){s.put(new Request(`https://LOCALCACHE/${encodeURIComponent(e)}`),new Response(t)),n()})).catch((()=>{s()}))}))},self.addEventListener("activate",(async function(e){self.clients.claim()})),self.addEventListener("install",(async function(e){self.skipWaiting(),e.waitUntil(caches.open("Keee-sw").then((async function(e){return await db.read("uuid")||await db.write("uuid",generate_uuid()),e.addAll(cachelist)})))}));const handleerr=async(e,t)=>new Response(`<h1>sw挂了</h1>\n    <b>${t}</b>`,{headers:{"content-type":"text/html; charset=utf-8"}});let cdn={gh:{zzko:{url:"https://cdn.jsdmirror.com/gh"},jsdelivr:{url:"https://cdn.jsdmirror.com/gh"}},npm:{eleme:{url:"https://npm.elemecdn.com"},zzko:{url:"https://cdn.jsdmirror.com/npm"},jsdelivr:{url:"https://cdn.jsdmirror.com/npm"}}};const cache_url_list=["keee.top"],blog_default_version="1.0.1",handle=async function(e){set_blog_config(await db.read("blog_version")||"1.0.1");await e.clone();const t=e.url;let n=new URL(t);await db.read("uuid");const s=n.href.substr(n.origin.length),r=(n.port,t.split("/")[2]);if(s.match(/\/sw\.js/g))return fetch(e);if(s.match(/\/null/g))return null;if(s.match(/\/undefined/g))return null;s.split("?")[0];const c=e=>n.searchParams.get(e);let o=[],a=JSON.parse(await db.read("msg"))||(async()=>(await db.write("msg","[]"),"[]"))();const i=t.split("?")[0],l=new Request(i),h=async e=>{const t=await caches.open("Keee-sw");await t.delete(e)};if("true"==c("nosw"))return fetch(e);if("true"==c("delete"))return h(l),a.push({name:"文件已删除",time:new Date,info:`已删除${i}`}),await db.write("msg",JSON.stringify(a)),new Response(JSON.stringify({ok:1}));if("true"==c("forceupdate"))return a.push({name:"文件已强制更新",time:new Date,info:`已更新${i}`}),await db.write("msg",JSON.stringify(a)),await fetch(e).then((function(t){return caches.open("Keee-sw").then((function(n){return h(l),n.put(e,t.clone()),t}))})),new Response(JSON.stringify({ok:1}));for(let n in cdn)for(let s in cdn[n])if(r==cdn[n][s].url.split("https://")[1].split("/")[0]&&t.match(cdn[n][s].url)){o=[];for(let e in cdn[n])o.push(t.replace(cdn[n][s].url,cdn[n][e].url));return caches.match(e).then((function(n){return n||lfetch(o,t).then((function(t){return caches.open("Keee-sw").then((function(n){return n.put(e,t.clone()),t}))}))}))}for(var u in blog.origin)if(r.split(":")[0]==blog.origin[u].split(":")[0]){if(blog.local)return fetch(e);setTimeout((async()=>{await set_newest_blogver()}),3e4),o=[];for(let e in blog.npmmirror)o.push(blog.npmmirror[e]+fullpath(s));const n=async e=>new Response(await e.arrayBuffer(),{headers:{"Content-Type":"text/html;charset=utf-8"},status:e.status,statusText:e.statusText});return new Promise(((r,c)=>{setTimeout((()=>{caches.match(e).then((function(c){c?(cons.s(`Cache Hited! | Origin:${t}`),setTimeout((()=>{r(c)}),200),setTimeout((()=>{lfetch(o,t).then((async function(c){return caches.open("Keee-sw").then((async function(o){if(o.delete(e),cons.s(`Cache Updated! | Origin:${t}`),fullpath(s).match(/\.html$/g)){const t=await n(c);o.put(e,t.clone()),r(t)}else o.put(e,c.clone()),r(c)}))}))}),0)):(cons.w(`Cache Missed! | Origin:${t}`),setTimeout((()=>{lfetch(o,t).then((async function(t){return caches.open("Keee-sw").then((async function(c){if(fullpath(s).match(/\.html$/g)){const s=await n(t);c.put(e,s.clone()),r(s)}else c.put(e,t.clone()),r(t)}))})).catch((function(e){r(caches.match(new Request("/offline.html")))}))}),0),setTimeout((()=>{r(caches.match(new Request("/offline.html")))}),5e3))}))}),0)}))}for(var u in cache_url_list)if(t.match(cache_url_list[u]))return caches.match(e).then((function(t){return t||fetch(e).then((function(t){return caches.open("Keee-sw").then((function(n){return n.put(e,t.clone()),t}))}))}));return fetch(e)},lfetch=async(e,t)=>{cons.i(`LFetch Handled! | Mirrors Count:${e.length} | Origin: ${t}`);const n=(new Date).getTime();await db.read("uuid");Promise.any||(Promise.any=function(e){return new Promise(((t,n)=>{let s=(e=Array.isArray(e)?e:[]).length,r=[];if(0===s)return n(new AggregateError("All promises were rejected"));e.forEach((e=>{e.then((e=>{t(e)}),(e=>{s--,r.push(e),0===s&&n(new AggregateError(r))}))}))}))});let s=new AbortController;const r=async e=>new Response(await e.arrayBuffer(),{status:e.status,headers:e.headers});return Promise.any(e.map((async e=>new Promise((async(c,o)=>{fetch(e,{signal:s.signal}).then(r).then((async e=>{const r=e.clone();200==r.status?(s.abort(),cons.s(`LFetch Success! | Time: ${(new Date).getTime()-n}ms | Origin: ${t} `),c(r)):o(null)})).catch((e=>{String(e).match("The user aborted a request")||String(e).match("Failed to fetch")?console.log():String(e).match("been blocked by CORS policy")?cons.e(`LFetch Blocked by CORS policy! | Origin: ${t}`):cons.e(`LFetch Error! | Origin: ${t} | Reason: ${e}`),o(null)}))}))))).then((e=>e)).catch((()=>null))},fullpath=e=>((e=e.split("?")[0].split("#")[0]).match(/\/$/)&&(e+="index"),e.match(/\.[a-zA-Z0-9]+$/)||(e+=".html"),e),set_blog_config=e=>{self.packagename="cqlkc-mirror",self.blogversion=e,self.blog={local:0,origin:["blog.keee.top"],plus:["blog.keee.top"],npmmirror:[`https://cdn.jsdmirror.com/npm/${packagename}@${blogversion}`]}},set_newest_blogver=async()=>{self.packagename="cqlkc-mirror";const e=[`https://registry.npmmirror.com/${packagename}/latest`,`https://registry.npmjs.org/${packagename}/latest`];return cons.i("Searching For The Newest Version..."),lfetch(e,e[0]).then((e=>e.json())).then((async e=>{if(!e.version)throw"No Version Found!";const t=choose_the_newest_version(e.version,await db.read("blog_version")||"1.0.1");if(cons.d(`Newest Version: ${e.version} ; Local Version: ${await db.read("blog_version")} | Update answer: ${t}`),cons.s(`Update Blog Version To ${t}`),t!==await db.read("blog_version")&&"1.0.1"!==t){self.clients.matchAll().then((function(e){e&&e.length&&e.forEach((function(e){e.postMessage("sw.update")}))}))}await db.write("blog_version",t),set_blog_config(t)})).catch((e=>{cons.e(`Get Blog Newest Version Erorr!Reseon:${e}`),set_blog_config("1.0.1")}))},choose_the_newest_version=(e,t)=>{const n=e=>{const t=e.split(".")[0];return[parseInt(t),e.replace(t+".","")]},s=(r,c)=>{const[o,a]=n(r),[i,l]=n(c);return cons.d(`n1:${o} s1:${a} n2:${i} s2:${l}`),o>i?e:o<i?t:a.match(/\./)||l.match(/\./)?s(a,l):parseInt(a)>parseInt(l)?e:t};return s(e,t)};setInterval((async()=>{cons.i("Trying to fetch the newest version..."),await set_newest_blogver()}),24e4),self.addEventListener("fetch",(async e=>{try{e.respondWith(handle(e.request))}catch(t){e.respondWith(handleerr(e.request,t))}}));