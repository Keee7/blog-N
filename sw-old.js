const CACHE_NAME="ICDNCache";let cachelist=[];self.addEventListener("install",(async function(e){self.skipWaiting(),e.waitUntil(caches.open(CACHE_NAME).then((function(e){return console.log("Opened cache"),e.addAll(cachelist)})))})),self.addEventListener("fetch",(async e=>{try{e.respondWith(handle(e.request))}catch(t){e.respondWith(handleerr(e.request,t))}}));const handleerr=async(e,t)=>new Response(`<h1>sw挂了</h1>\n    <b>${t}</b>`,{headers:{"content-type":"text/html; charset=utf-8"}});let cdn={gh:{jsdelivr:{url:"https://cdn.jsdelivr.net/gh"},tianli:{url:"https://cdn1.tianli0.top/gh"}},combine:{jsdelivr:{url:"https://cdn.jsdelivr.net/combine"},jsdelivr_fastly:{url:"https://fastly.jsdelivr.net/combine"}},npm:{afdelivr:{url:"https://cdn.afdelivr.top/npm"},eleme:{url:"https://npm.elemecdn.com"},jsdelivr:{url:"https://cdn.jsdelivr.net/npm"},jsdelivr_fastly:{url:"https://fastly.jsdelivr.net/npm"},zhimg:{url:"https://unpkg.zhimg.com"},unpkg:{url:"https://unpkg.com"},tianli:{url:"https://cdn1.tianli0.top/npm"}}};const handle=async function(e){const t=e.url,n=t.split("/")[2],r=new URL(t),s=r.pathname,c=r.href.substr(r.origin.length);let l=[];if(c.match(/\/sw\.js/g))return fetch(e);if("cqlkc.top"===n)return lfetch(generate_blog_urls("cqlkc-mirror",await db.read("blog_version")||"1.0.1",fullpath(s))).then((e=>e.arrayBuffer())).then((e=>new Response(e,{headers:{"Content-Type":"text/html;charset=utf-8"}})));for(let r in cdn)for(let s in cdn[r])if(n==cdn[r][s].url.split("https://")[1].split("/")[0]&&t.match(cdn[r][s].url)){l=[];for(let e in cdn[r])l.push(t.replace(cdn[r][s].url,cdn[r][e].url));return t.indexOf("@latest/")>-1?lfetch(l,t):caches.match(e).then((function(n){return n||lfetch(l,t).then((function(t){return caches.open(CACHE_NAME).then((function(n){return n.put(e,t.clone()),t}))}))}))}return fetch(e)},lfetch=async(e,t)=>{let n=new AbortController;const r=async e=>new Response(await e.arrayBuffer(),{status:e.status,headers:e.headers});return Promise.any||(Promise.any=function(e){return new Promise(((t,n)=>{let r=(e=Array.isArray(e)?e:[]).length,s=[];if(0===r)return n(new AggregateError("All promises were rejected"));e.forEach((e=>{e.then((e=>{t(e)}),(e=>{r--,s.push(e),0===r&&n(new AggregateError(s))}))}))}))}),Promise.any(e.map((e=>new Promise(((t,s)=>{fetch(e,{signal:n.signal}).then(r).then((e=>{200==e.status?(n.abort(),t(e)):s(e)}))})))))},fullpath=e=>((e=e.split("?")[0].split("#")[0]).match(/\/$/)&&(e+="index"),e.match(/\.[a-zA-Z]+$/)||(e+=".html"),e),generate_blog_urls=(e,t,n)=>{const r=[`https://cdn.afdelivr.top/npm/${e}@${t}`,`https://unpkg.com/${e}@${t}`,`https://npm.elemecdn.com/${e}@${t}`,`https://cdn.jsdelivr.net/npm/${e}@${t}`,`https://npm.sourcegcdn.com/npm/${e}@${t}`,`https://cdn1.tianli0.top/npm/${e}@${t}`];for(var s in r)r[s]+=n;return r},mirror=["https://registry.npmmirror.com/cqlkc-mirror/latest","https://registry.npmjs.org/cqlkc-mirror/latest","https://mirrors.cloud.tencent.com/npm/cqlkc-mirror/latest"],get_newest_version=async e=>lfetch(e,e[0]).then((e=>e.json())).then(res.version);self.db={read:(e,t)=>(t||(t={type:"text"}),new Promise(((t,n)=>{caches.open(CACHE_NAME).then((n=>{n.match(new Request(`https://LOCALCACHE/${encodeURIComponent(e)}`)).then((function(e){e||t(null),e.text().then((e=>t(e)))})).catch((()=>{t(null)}))}))}))),write:(e,t)=>new Promise(((n,r)=>{caches.open(CACHE_NAME).then((function(r){r.put(new Request(`https://LOCALCACHE/${encodeURIComponent(e)}`),new Response(t)),n()})).catch((()=>{r()}))}))};const set_newest_version=async e=>lfetch(e,e[0]).then((e=>e.json())).then((async e=>{await db.write("blog_version",e.version)}));setInterval((async()=>{await set_newest_version(mirror)}),6e4),setTimeout((async()=>{await set_newest_version(mirror)}),5e3);